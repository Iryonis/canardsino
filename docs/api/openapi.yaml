openapi: 3.0.3
info:
  title: CoinCoin Casino API
  description: |
    API complète pour la plateforme de casino en ligne CoinCoin.
    
    ## Architecture
    - **Microservices** : Auth, Wallet, Game Engine, Chat, Stats, Prices
    - **Message Bus** : RabbitMQ pour la communication inter-services
    - **Blockchain** : Polygon pour ETH/USDC et token CCC
    
    ## Flux de l'utilisateur
    1. Register/Login → JWT Token
    2. Dépôt crypto (ETH/USDC) → Conversion en CCC (1000 CCC = 1$)
    3. Jouer à la roulette ou Duck Race → Mise en CCC
    4. Recevoir résultats en temps réel (SSE/WebSocket)
    5. Voir dashboard avec stats
    
    ## Jeux disponibles
    - **Roulette Européenne** : 37 numéros (0-36), paris variés
    - **Duck Race** : Course de canards multijoueur (1-5 joueurs, WebSocket)
    
    ## Taux de conversion
    - 1000 CCC = 1 USD (fixe)
    - Prix ETH/USDC via CoinMarketCap API
  version: 1.0.0
  contact:
    name: CoinCoin Casino Support
    email: support@coincoincasino.com

servers:
  - url: http://localhost
    description: Development (via NGINX)

tags:
  - name: Auth
    description: Authentification et gestion des utilisateurs
  - name: Wallet
    description: Gestion du portefeuille crypto et CCC
  - name: Roulette
    description: Jeu de la roulette européenne
  - name: Duck Race
    description: Course de canards multijoueur (WebSocket)
  - name: Chat
    description: Chat en temps réel (WebSocket)
  - name: Stats
    description: Statistiques et dashboard (SSE)
  - name: Prices
    description: Prix des cryptomonnaies

security:
  - bearerAuth: []

paths:
  # ==================== AUTH SERVICE ====================
  /auth/register:
    post:
      tags:
        - Auth
      summary: Créer un nouveau compte utilisateur
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - username
                - password
              properties:
                email:
                  type: string
                  format: email
                username:
                  type: string
                  minLength: 3
                password:
                  type: string
                  minLength: 8
      responses:
        '201':
          description: Compte créé avec succès
        '409':
          description: Email ou username déjà utilisé

  /auth/login:
    post:
      tags:
        - Auth
      summary: Se connecter
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                password:
                  type: string
      responses:
        '200':
          description: Connexion réussie (retourne accessToken et refreshToken)

  /auth/refresh:
    post:
      tags:
        - Auth
      summary: Rafraîchir le token JWT
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refreshToken
              properties:
                refreshToken:
                  type: string
      responses:
        '200':
          description: Token rafraîchi

  /auth/profile:
    get:
      tags:
        - Auth
      summary: Profil utilisateur
      responses:
        '200':
          description: Profil récupéré

  # ==================== WALLET SERVICE ====================
  /wallet/deposit-info:
    get:
      tags:
        - Wallet
      summary: Informations de dépôt
      security: []
      responses:
        '200':
          description: Adresse wallet et tokens supportés

  /wallet/balance:
    get:
      tags:
        - Wallet
      summary: Solde du wallet
      responses:
        '200':
          description: Solde en CCC

  /wallet/deposit:
    post:
      tags:
        - Wallet
      summary: Traiter un dépôt crypto
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - txHash
                - walletAddress
              properties:
                txHash:
                  type: string
                walletAddress:
                  type: string
                cryptoSymbol:
                  type: string
      responses:
        '200':
          description: Dépôt traité

  /wallet/transactions:
    get:
      tags:
        - Wallet
      summary: Historique des transactions
      responses:
        '200':
          description: Liste des transactions

  /wallet/give:
    post:
      tags:
        - Wallet
      summary: Give tokens (test only)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - amount
              properties:
                amount:
                  type: integer
      responses:
        '200':
          description: Tokens crédités

  # ==================== ROULETTE ====================
  /roulette/config:
    get:
      tags:
        - Roulette
      summary: Configuration de la roulette
      security: []
      responses:
        '200':
          description: Configuration (numéros, couleurs, payouts)

  /roulette/history:
    get:
      tags:
        - Roulette
      summary: Historique des parties
      parameters:
        - name: token
          in: query
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Historique

  /roulette/big-wins:
    get:
      tags:
        - Roulette
      summary: Gros gains récents
      security: []
      responses:
        '200':
          description: Big wins (multiplier >= 10x)

  /roulette/bets:
    post:
      tags:
        - Roulette
      summary: Placer des paris (format raw)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - bets
              properties:
                bets:
                  type: array
                  items:
                    type: object
      responses:
        '200':
          description: Paris placés

  /roulette/simple-bets:
    post:
      tags:
        - Roulette
      summary: Placer des paris (format simplifié)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - simpleBets
              properties:
                simpleBets:
                  type: array
                  items:
                    type: object
      responses:
        '200':
          description: Paris placés

  /roulette/spin:
    post:
      tags:
        - Roulette
      summary: Lancer la roulette
      responses:
        '200':
          description: Résultat du spin

  /roulette/bets/{userId}:
    get:
      tags:
        - Roulette
      summary: Paris en cours
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Paris actuels
    delete:
      tags:
        - Roulette
      summary: Annuler les paris
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Paris annulés

  /roulette/balance:
    get:
      tags:
        - Roulette
      summary: Solde via game engine
      responses:
        '200':
          description: Solde

  /roulette/validate-bet:
    post:
      tags:
        - Roulette
      summary: Valider un pari
      responses:
        '200':
          description: Validation

  /roulette/calculate-potential-payout:
    post:
      tags:
        - Roulette
      summary: Calculer le gain potentiel
      responses:
        '200':
          description: Gain potentiel

  # ==================== DUCK RACE (WebSocket) ====================
  /games/duck-race/ws:
    get:
      tags:
        - Duck Race
      summary: WebSocket Duck Race
      description: |
        **Flow:** LOBBY → CREATE_ROOM/JOIN_ROOM → WAITING → SET_READY → COUNTDOWN → RACING → FINISHED
        
        **Messages Client → Serveur:**
        - AUTHENTICATE, GET_ROOM_LIST, CREATE_ROOM, JOIN_ROOM, LEAVE_ROOM, SET_READY, GET_ROOM_STATE
        
        **Messages Serveur → Client:**
        - AUTHENTICATED, ROOM_LIST, ROOM_CREATED, ROOM_UPDATED, ROOM_DELETED, ROOM_STATE
        - PLAYER_JOINED, PLAYER_LEFT, PLAYER_READY, ALL_READY
        - COUNTDOWN_TICK, RACE_STARTED, RACE_UPDATE, RACE_FINISHED
        - BALANCE_UPDATE, WAITING_FOR_PLAYERS
        - ERROR (codes: RACE_CANCELLED, INSUFFICIENT_BALANCE, ROOM_FULL, ROOM_NOT_FOUND, INVALID_PHASE)
      responses:
        '101':
          description: WebSocket établi

  # ==================== CHAT (WebSocket) ====================
  /chat/ws:
    get:
      tags:
        - Chat
      summary: WebSocket Chat et événements
      description: Reçoit game results, big wins, system events
      security: []
      responses:
        '101':
          description: WebSocket établi

  # ==================== STATS ====================
  /stats/health:
    get:
      tags:
        - Stats
      summary: Health check
      security: []
      responses:
        '200':
          description: Service healthy

  /stats/stream:
    get:
      tags:
        - Stats
      summary: SSE stream statistiques
      description: Stream SSE avec initial-stats et heartbeat
      parameters:
        - name: token
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: SSE stream

  # ==================== PRICES ====================
  /prices/quotes:
    get:
      tags:
        - Prices
      summary: Prix de toutes les cryptos
      security: []
      responses:
        '200':
          description: Prix (cached)

  /prices/supported:
    get:
      tags:
        - Prices
      summary: Cryptos supportées
      security: []
      responses:
        '200':
          description: Liste des symbols

  /prices/deposit-tokens:
    get:
      tags:
        - Prices
      summary: Tokens de dépôt
      security: []
      responses:
        '200':
          description: Tokens acceptés sur Polygon

  /prices/convert/{symbol}/{amount}:
    get:
      tags:
        - Prices
      summary: Convertir crypto en CCC
      security: []
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
        - name: amount
          in: path
          required: true
          schema:
            type: number
      responses:
        '200':
          description: Conversion

  /prices/{symbol}:
    get:
      tags:
        - Prices
      summary: Prix d'une crypto
      security: []
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Prix

  /prices/health:
    get:
      tags:
        - Prices
      summary: Health check
      security: []
      responses:
        '200':
          description: Service health

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
