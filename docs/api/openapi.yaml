openapi: 3.0.3
info:
  title: CoinCoin Casino API
  description: |
    API complète pour la plateforme de casino en ligne CoinCoin.
    
    ## Architecture
    - **Microservices** : Auth, Wallet, Game Engine, Chat, Stats, Prices, Random
    - **Message Bus** : RabbitMQ pour la communication inter-services
    - **Blockchain** : Polygon pour ETH/USDC et token CCC
    
    ## Flux de l'utilisateur
    1. Register/Login → JWT Token
    2. Dépôt crypto (ETH/USDC) → Conversion en CCC (1000 CCC = 1$)
    3. Jouer à la roulette ou Duck Race → Mise en CCC
    4. Recevoir résultats en temps réel (SSE/WebSocket)
    5. Voir dashboard avec stats
    
    ## Jeux disponibles
    - **Roulette Européenne** : 37 numéros (0-36), paris variés
    - **Duck Race** : Course de canards multijoueur (1-5 joueurs, WebSocket)
    
    ## Taux de conversion
    - 1000 CCC = 1 USD (fixe)
    - Prix ETH/USDC via CoinMarketCap API
  version: 1.0.0
  contact:
    name: CoinCoin Casino Support
    email: support@coincoincasino.com

servers:
  - url: http://localhost/api
    description: Development (via NGINX)

tags:
  - name: Authentication
    description: Authentification et gestion des utilisateurs
  - name: Wallet
    description: Gestion du portefeuille crypto et CCC
  - name: Internal
    description: Routes internes pour communication inter-services
  - name: Roulette
    description: Jeu de la roulette européenne
  - name: Duck Race
    description: Course de canards multijoueur (WebSocket)
  - name: Chat
    description: Chat en temps réel et système de messages
  - name: Stats
    description: Statistiques en temps réel (SSE)
  - name: Prices
    description: Prix des cryptomonnaies via CoinMarketCap
  - name: Health
    description: Health checks des services
  - name : Random
    description: Service de génération de nombres aléatoires

security:
  - bearerAuth: []

paths:
  # ==================== AUTH SERVICE ====================
  /auth/register:
    post:
      tags:
        - Authentication
      summary: Register a new user
      description: Create a new user account with email, username, and password
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - username
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                username:
                  type: string
                  minLength: 3
                  example: player123
                password:
                  type: string
                  minLength: 8
                  format: password
                  example: securePassword123
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    type: object
                    properties:
                      id:
                        type: string
                      email:
                        type: string
                      username:
                        type: string
                      createdAt:
                        type: string
                        format: date-time
                  tokens:
                    type: object
                    properties:
                      accessToken:
                        type: string
                      refreshToken:
                        type: string
        '400':
          description: Validation error
        '409':
          description: Email or username already exists

  /auth/login:
    post:
      tags:
        - Authentication
      summary: Login user
      description: Authenticate with email and password to receive JWT tokens
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  example: securePassword123
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    type: object
                    properties:
                      id:
                        type: string
                      email:
                        type: string
                      username:
                        type: string
                      createdAt:
                        type: string
                        format: date-time
                  tokens:
                    type: object
                    properties:
                      accessToken:
                        type: string
                      refreshToken:
                        type: string
        '401':
          description: Invalid credentials

  /auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh access token
      description: Exchange a refresh token for new access and refresh tokens (token rotation)
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refreshToken
              properties:
                refreshToken:
                  type: string
      responses:
        '200':
          description: Tokens refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  accessToken:
                    type: string
                  refreshToken:
                    type: string
        '401':
          description: Invalid or expired refresh token

  /auth/profile:
    get:
      tags:
        - Authentication
      summary: Get user profile
      description: Retrieve the authenticated user's profile information
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  email:
                    type: string
                  username:
                    type: string
                  createdAt:
                    type: string
                    format: date-time
        '401':
          description: Not authenticated

  # ==================== WALLET SERVICE ====================
  /wallet/deposit-info:
    get:
      tags:
        - Wallet
      summary: Get deposit information
      description: Get the hot wallet address and supported tokens for deposits (public endpoint)
      security: []
      responses:
        '200':
          description: Deposit configuration
          content:
            application/json:
              schema:
                type: object
                properties:
                  hotWalletAddress:
                    type: string
                    example: "0x742d35Cc6634C0532925a3b844Bc9e7595f..."
                  supportedTokens:
                    type: array
                    items:
                      type: object
                      properties:
                        symbol:
                          type: string
                        address:
                          type: string
                        decimals:
                          type: integer
                  cccPerUSD:
                    type: integer
                    example: 1000
                  network:
                    type: string
                    example: "Polygon"
                  chainId:
                    type: integer
                    example: 137

  /wallet/balance:
    get:
      tags:
        - Wallet
      summary: Get user balance
      description: Retrieve the authenticated user's CCC balance
      responses:
        '200':
          description: User balance
          content:
            application/json:
              schema:
                type: object
                properties:
                  balance:
                    type: number
                    example: 50000
                  userId:
                    type: string
        '401':
          description: Not authenticated

  /wallet/deposit:
    post:
      tags:
        - Wallet
      summary: Process crypto deposit
      description: Verify a blockchain transaction and credit CCC tokens to the user's account
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - txHash
                - walletAddress
              properties:
                txHash:
                  type: string
                  description: Polygon transaction hash
                  example: "0x123abc..."
                walletAddress:
                  type: string
                  description: User's wallet address that sent the deposit
                  example: "0x742d35Cc..."
                cryptoSymbol:
                  type: string
                  description: Cryptocurrency symbol (default ETH)
                  example: "ETH"
      responses:
        '200':
          description: Deposit processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  transaction:
                    type: object
                  newBalance:
                    type: number
        '400':
          description: Invalid transaction or already processed

  /wallet/transactions:
    get:
      tags:
        - Wallet
      summary: Get transaction history
      description: Retrieve the user's transaction history (last 50 transactions)
      responses:
        '200':
          description: Transaction list
          content:
            application/json:
              schema:
                type: object
                properties:
                  transactions:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        type:
                          type: string
                          enum: [deposit, withdrawal, bet, win]
                        amount:
                          type: number
                        createdAt:
                          type: string
                          format: date-time

  /wallet/give:
    post:
      tags:
        - Wallet
      summary: Give tokens (test only)
      description: Self-credit CCC tokens for testing purposes
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - amount
              properties:
                amount:
                  type: integer
                  minimum: 1
                  example: 10000
      responses:
        '200':
          description: Tokens credited
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  amount:
                    type: integer
                  newBalance:
                    type: number

  /wallet/internal/update-balance:
    post:
      tags:
        - Internal
      summary: Update balance (internal)
      description: Internal endpoint for game engine to update user balance after bets/wins
      security:
        - internalApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
                - amount
                - type
              properties:
                userId:
                  type: string
                amount:
                  type: number
                  description: Positive for wins, negative for bets
                type:
                  type: string
                  enum: [win, bet]
      responses:
        '200':
          description: Balance updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  newBalance:
                    type: number

  /wallet/internal/balance/{userId}:
    get:
      tags:
        - Internal
      summary: Get balance by userId (internal)
      description: Internal endpoint for game engine to get user balance
      security:
        - internalApiKey: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: User balance
          content:
            application/json:
              schema:
                type: object
                properties:
                  balance:
                    type: number
                  userId:
                    type: string

  # ==================== GAME ENGINE / ROULETTE ====================
  /games/roulette/config:
    get:
      tags:
        - Roulette
      summary: Get roulette configuration
      description: Get roulette wheel layout, colors, and payout rates
      security: []
      responses:
        '200':
          description: Roulette configuration
          content:
            application/json:
              schema:
                type: object
                properties:
                  redNumbers:
                    type: array
                    items:
                      type: integer
                  blackNumbers:
                    type: array
                    items:
                      type: integer
                  payouts:
                    type: object
                    properties:
                      straight:
                        type: integer
                        example: 35
                      red:
                        type: integer
                        example: 1

  /games/roulette/history:
    get:
      tags:
        - Roulette
      summary: Get game history
      description: Get the user's roulette game history with pagination
      security:
        - bearerAuth: []
      parameters:
        - name: token
          in: query
          description: JWT token (alternative to Authorization header)
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Game history
          content:
            application/json:
              schema:
                type: object
                properties:
                  history:
                    type: array
                    items:
                      type: object
                  pagination:
                    type: object
                    properties:
                      page:
                        type: integer
                      totalPages:
                        type: integer
                      hasNextPage:
                        type: boolean

  /games/roulette/big-wins:
    get:
      tags:
        - Roulette
      summary: Get big wins
      description: Get recent big wins (10x multiplier or higher)
      security: []
      responses:
        '200':
          description: Big wins list
          content:
            application/json:
              schema:
                type: object
                properties:
                  bigWins:
                    type: array
                    items:
                      type: object
                  count:
                    type: integer

  /games/roulette/bets:
    post:
      tags:
        - Roulette
      summary: Place bets (raw format)
      description: Place one or more bets on the roulette table using raw bet format
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - bets
              properties:
                bets:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                        enum: [straight, split, street, corner, line, column, dozen, red, black, odd, even, high, low]
                      numbers:
                        type: array
                        items:
                          type: integer
                      amount:
                        type: integer
                        minimum: 2000
      responses:
        '200':
          description: Bets placed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  userId:
                    type: string
                  totalAmount:
                    type: number
        '400':
          description: Invalid bet or insufficient balance

  /games/roulette/simple-bets:
    post:
      tags:
        - Roulette
      summary: Place bets (simplified format)
      description: Place bets using a simplified format compatible with the frontend
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - simpleBets
              properties:
                simpleBets:
                  type: array
                  items:
                    type: object
                    required:
                      - type
                      - amount
                    properties:
                      type:
                        type: string
                        enum: [straight, red, black, odd, even, high, low, column, dozen]
                      value:
                        oneOf:
                          - type: integer
                          - type: string
                      amount:
                        type: integer
                        minimum: 2000
      responses:
        '200':
          description: Bets placed successfully

  /games/roulette/spin:
    post:
      tags:
        - Roulette
      summary: Spin the wheel
      description: Spin the roulette wheel, calculate results, and credit winnings
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Spin result
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  result:
                    type: object
                    properties:
                      totalBet:
                        type: number
                      totalWin:
                        type: number
                      netResult:
                        type: number
                      spinResult:
                        type: integer
                        minimum: 0
                        maximum: 36
        '400':
          description: No bets placed

  /games/roulette/bets/{userId}:
    get:
      tags:
        - Roulette
      summary: Get current bets
      description: Get the user's currently placed bets (before spin)
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Current bets
          content:
            application/json:
              schema:
                type: object
                properties:
                  userId:
                    type: string
                  bets:
                    type: array
                    items:
                      type: object
                  totalAmount:
                    type: number
    delete:
      tags:
        - Roulette
      summary: Cancel bets
      description: Cancel all current bets for a user
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Bets cancelled

  /games/roulette/balance:
    get:
      tags:
        - Roulette
      summary: Get balance via game engine
      description: Get user balance through the game engine (proxied from wallet service)
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User balance
          content:
            application/json:
              schema:
                type: object
                properties:
                  balance:
                    type: number

  /games/roulette/validate-bet:
    post:
      tags:
        - Roulette
      summary: Validate a bet
      description: Validate a single bet before placing it
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                type:
                  type: string
                value:
                  oneOf:
                    - type: integer
                    - type: string
                amount:
                  type: integer
      responses:
        '200':
          description: Validation result
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                  potentialPayout:
                    type: number
                  error:
                    type: string

  /games/roulette/calculate-potential-payout:
    post:
      tags:
        - Roulette
      summary: Calculate potential payout
      description: Calculate the realistic maximum potential win for a list of bets
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                simpleBets:
                  type: array
                  items:
                    type: object
      responses:
        '200':
          description: Payout calculation
          content:
            application/json:
              schema:
                type: object
                properties:
                  totalBet:
                    type: number
                  maxPotentialWin:
                    type: number
                  minPotentialWin:
                    type: number

  # ==================== DUCK RACE (WebSocket) ====================
  /games/duck-race/ws:
    get:
      tags:
        - Duck Race
      summary: WebSocket Duck Race
      description: |
        **Flow:** LOBBY → CREATE_ROOM/JOIN_ROOM → WAITING → SET_READY → COUNTDOWN → RACING → FINISHED
        
        **Messages Client → Serveur:**
        - AUTHENTICATE, GET_ROOM_LIST, CREATE_ROOM, JOIN_ROOM, LEAVE_ROOM, SET_READY, GET_ROOM_STATE
        
        **Messages Serveur → Client:**
        - AUTHENTICATED, ROOM_LIST, ROOM_CREATED, ROOM_UPDATED, ROOM_DELETED, ROOM_STATE
        - PLAYER_JOINED, PLAYER_LEFT, PLAYER_READY, ALL_READY
        - COUNTDOWN_TICK, RACE_STARTED, RACE_UPDATE, RACE_FINISHED
        - BALANCE_UPDATE, WAITING_FOR_PLAYERS
        - ERROR (codes: RACE_CANCELLED, INSUFFICIENT_BALANCE, ROOM_FULL, ROOM_NOT_FOUND, INVALID_PHASE)
      security: []
      responses:
        '101':
          description: WebSocket établi

  # ==================== CHAT SERVICE ====================
  /chat/health:
    get:
      tags:
        - Health
      summary: Chat service health check
      security: []
      responses:
        '200':
          description: Service health with client count
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  clients:
                    type: integer
                    description: Number of connected WebSocket clients

  /chat/system-message:
    post:
      tags:
        - Chat
      summary: Broadcast system message
      description: Send a system message to all connected clients (big wins, announcements)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - message
              properties:
                message:
                  type: string
                  example: "Player123 just won 100,000 CCC!"
      responses:
        '200':
          description: Message broadcasted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '400':
          description: Message is required

  /chat/ws:
    get:
      tags:
        - Chat
      summary: WebSocket Chat et événements
      description: Reçoit game results, big wins, system events
      security: []
      responses:
        '101':
          description: WebSocket établi

  # ==================== STATS SERVICE ====================
  /stats/health:
    get:
      tags:
        - Health
      summary: Stats service health check
      security: []
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  service:
                    type: string
                    example: stats
                  mongodb:
                    type: boolean
                  uptime:
                    type: number

  /stats/stream:
    get:
      tags:
        - Stats
      summary: Real-time stats stream (SSE)
      description: |
        Server-Sent Events stream for real-time user statistics.

        **Events:**
        - `initial-stats`: Sent on connection with user's game statistics
        - Heartbeat comments every 30 seconds

        **Authentication:** Use `token` query parameter (EventSource doesn't support headers)
      parameters:
        - name: token
          in: query
          required: true
          description: JWT access token
          schema:
            type: string
      responses:
        '200':
          description: SSE stream established
          content:
            text/event-stream:
              schema:
                type: string
                example: |
                  event: initial-stats
                  data: {"totalGames": 50, "totalWins": 25, "totalLosses": 25}
        '401':
          description: Invalid or missing token

  # ==================== PRICES SERVICE (CoinMarketCap) ====================
  /prices/quotes:
    get:
      tags:
        - Prices
      summary: Get all crypto prices
      description: Get current prices for all supported cryptocurrencies (cached)
      security: []
      responses:
        '200':
          description: Price quotes
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    additionalProperties:
                      type: number
                    example:
                      ETH: 3500.42
                      BTC: 65000.00
                      USDC: 1.00
                  cached:
                    type: boolean
                  timestamp:
                    type: string
                    format: date-time

  /prices/supported:
    get:
      tags:
        - Prices
      summary: List supported cryptocurrencies
      description: Get list of all supported cryptocurrency symbols
      security: []
      responses:
        '200':
          description: Supported symbols
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: string
                    example: ["ETH", "BTC", "USDC", "WETH"]
                  timestamp:
                    type: string
                    format: date-time

  /prices/deposit-tokens:
    get:
      tags:
        - Prices
      summary: Get deposit token info
      description: Get information about tokens accepted for deposits on Polygon
      security: []
      responses:
        '200':
          description: Deposit tokens
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        symbol:
                          type: string
                        address:
                          type: string
                        decimals:
                          type: integer
                        name:
                          type: string
                  network:
                    type: string
                    example: "Polygon"
                  chainId:
                    type: integer
                    example: 137

  /prices/convert/{symbol}/{amount}:
    get:
      tags:
        - Prices
      summary: Convert crypto to CCC
      description: Calculate CCC token amount for a given crypto amount
      security: []
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
          example: ETH
        - name: amount
          in: path
          required: true
          schema:
            type: number
          example: 0.1
      responses:
        '200':
          description: Conversion result
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      inputSymbol:
                        type: string
                        example: "ETH"
                      inputAmount:
                        type: number
                        example: 0.1
                      priceUSD:
                        type: number
                        example: 3500.42
                      usdValue:
                        type: number
                        example: 350.042
                      cccAmount:
                        type: integer
                        example: 350042
                      rate:
                        type: integer
                        example: 1000

  /prices/{symbol}:
    get:
      tags:
        - Prices
      summary: Get single crypto price
      description: Get current price for a specific cryptocurrency
      security: []
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
            enum: [ETH, BTC, USDC, WETH]
          example: ETH
      responses:
        '200':
          description: Price data
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      symbol:
                        type: string
                      price:
                        type: number
                  cached:
                    type: boolean
                  timestamp:
                    type: string
                    format: date-time
        '404':
          description: Cryptocurrency not supported

  /prices/health:
    get:
      tags:
        - Health
      summary: CoinMarketCap service health check
      security: []
      responses:
        '200':
          description: Service health with cache status
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy, degraded]
                  cacheStatus:
                    type: string
                  timestamp:
                    type: string
                    format: date-time

  # ==================== RANDOM SERVICE ====================
  /random/roulette:
    get:
      tags:
        - Random
      summary: Generate random roulette number
      description: Get a random number between 0 and 36 from Random.org API or fallback (internal service only)
      security:
        - internalApiKey: []
      responses:
        '200':
          description: Random number generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  number:
                    type: integer
                    minimum: 0
                    maximum: 36
                    example: 17
                  timestamp:
                    type: integer
                  source:
                    type: string
                    enum: [random.org, fallback]
                    example: random.org
        '401':
          description: Invalid internal API key

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtenu via /auth/login ou /auth/register
    internalApiKey:
      type: apiKey
      in: header
      name: x-internal-api-key
      description: Clé API pour les appels inter-services
